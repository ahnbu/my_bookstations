# 에러 로그 및 해결 방법

*모든 시간은 KST(UTC+9) 기준입니다.*

---
### **5. 도서관 재고 API 응답 유효성 검사 실패**

- **최초 발생일**: 2025-08-01 17:45
- **에러 현상**:
    - 도서관 재고 확인 시 "Library stock API response validation failed: [object Object]" 라는 오류가 발생하며 재고 정보가 표시되지 않는 문제.
- **원인 분석**:
    - 앱의 데이터 유효성 검사(Zod) 로직에서, 도서관의 대출 상태(`대출상태`)를 '대출가능'과 '대출불가' 두 가지 값으로만 한정하여 예상하고 있었습니다. (`z.enum(["대출가능", "대출불가"])`)
    - 하지만 실제 도서관 API는 '예약중', '대출중', '정리중' 등 예상치 못한 다양한 상태 값을 반환할 수 있습니다.
    - 앱이 예상하지 못한 값이 들어오자 유효성 검사에 실패하며 오류를 발생시켰습니다.
- **해결 방법**:
    - `types.ts` 파일의 `LibraryAvailabilitySchema`에서 `대출상태` 필드의 Zod 스키마를, 두 가지 값만 허용하는 `z.enum()`에서 어떤 문자열이든 받아들일 수 있는 `z.string()`으로 변경했습니다.
    - 이 수정을 통해, 앞으로 도서관 시스템에서 새로운 대출 상태가 추가되더라도 앱은 오류 없이 안정적으로 재고 정보를 처리할 수 있게 되었습니다. UI는 '대출가능'이 아닌 모든 상태를 동일하게 처리하므로 사용자 경험은 일관되게 유지됩니다.
- **교훈 및 예방 조치**:
    - 외부 시스템에 대한 데이터 검증 규칙을 설정할 때는, 현재 파악된 값뿐만 아니라 향후 추가될 수 있는 다양한 케이스를 고려하여 너무 엄격하지 않게, 유연하게 설계하는 것이 중요합니다.


### **4. API 응답 형식 변경으로 인한 런타임 에러**

- **최초 발생일**: 2025-08-01 15:45 (예방 조치)
- **에러 현상 (잠재적)**:
    - 외부 API(알라딘, 도서관 재고)의 응답 형식이 사전에 공지 없이 변경될 경우, 앱이 예기치 않은 데이터 구조(예: `null` 또는 `undefined` 필드)에 접근하려다 `TypeError`가 발생하며 비정상적으로 종료되는 문제.
- **원인 분석**:
    - TypeScript의 타입 정의는 컴파일 시점에만 유효하며, 런타임에 실제로 들어오는 데이터의 구조까지 보장해주지는 못합니다. 따라서 외부 요인에 의해 데이터 형식이 변경되면, 타입스크립트만으로는 이를 방어할 수 없습니다.
- **해결 방법**:
    - **Zod 라이브러리 도입**: 외부 API 응답을 받는 즉시, 미리 정의된 Zod 스키마를 사용하여 데이터의 구조와 타입을 실시간으로 검증합니다.
    - `safeParse`를 통해 유효성 검사를 수행하고, 만약 데이터가 스키마와 일치하지 않을 경우, 실제 로직을 실행하기 전에 즉시 에러를 발생시키고 사용자에게 알립니다.
    - 이를 통해 잘못된 데이터가 애플리케이션의 다른 부분으로 전파되는 것을 원천적으로 차단하여 런타임 안정성을 확보했습니다.
- **교훈 및 예방 조치**:
    - 외부 데이터 소스에 의존하는 프론트엔드 애플리케이션은 반드시 **방어적 프로그래밍**의 일환으로 런타임 데이터 검증 계층을 구현해야 합니다. 이는 예측 불가능한 외부 요인으로부터 서비스의 안정성을 지키는 핵심적인 방법입니다.

### **3. Google 로그인 시 "accounts.google.com에서 연결을 거부했습니다." 오류**

- **최초 발생일**: 2025-08-01 14:15
- **에러 현상**:
    - AI Studio와 같은 iframe 기반의 개발 환경 미리보기에서 'Google 로그인' 버튼을 클릭했을 때, 로그인 팝업이 뜨지 않고 콘솔에 "Refused to display 'https://accounts.google.com/...' in a frame because it set 'X-Frame-Options' to 'deny'." 와 유사한 메시지가 나타나며, 화면에는 연결 거부 메시지가 표시되는 문제.
- **원인 분석**:
    - Google의 로그인 페이지는 '클릭재킹(Clickjacking)'과 같은 보안 위협을 방지하기 위해 `X-Frame-Options: DENY` HTTP 헤더를 사용합니다.
    - 이 정책은 Google 로그인 페이지가 `<iframe>`이나 `<frame>`과 같은 '액자' 내부에 렌더링되는 것을 브라우저 수준에서 엄격하게 차단합니다.
    - AI Studio의 앱 미리보기는 본질적으로 iframe 내에서 실행되므로, 이 보안 정책에 위배되어 연결이 거부됩니다.
- **해결 방법**:
    - **임시 해결책 (개발 환경)**: AI Studio 환경의 '새 탭에서 미리보기 열기' 기능을 사용하여 앱을 iframe 외부의 독립된 탭에서 실행합니다. 이 독립된 페이지에서는 Google 로그인 페이지가 정상적으로 열립니다.
    - **궁극적인 해결책 (배포)**: Vercel, Netlify 등 실제 호스팅 서비스에 앱을 배포합니다. 배포된 앱은 iframe 없이 독립적으로 실행되므로 이 문제가 근본적으로 해결됩니다.

- **교훈 및 예방 조치**:
    - 소셜 로그인과 같이 외부 인증 페이지로 리디렉션되는 기능은 iframe 환경에서 테스트할 때 제약이 발생할 수 있음을 인지해야 합니다. 개발 초기부터 독립된 페이지에서 테스트하거나, 배포 환경에서의 테스트 계획을 미리 수립하는 것이 중요합니다.

### **2. CSV 내보내기 시 ISBN 번호 형식 오류**

- **최초 발생일**: 2025-08-01 13:15
- **에러 현상**:
    - '내 서재' 목록을 CSV 파일로 내보낸 후 Excel과 같은 스프레드시트 프로그램에서 열었을 때, 13자리의 긴 ISBN 번호가 지수 표기법(예: `9.79113E+12`)으로 표시되어 원본 데이터가 손상되는 문제.
- **원인 분석**:
    - CSV 파일 자체에는 `9791130629353`과 같은 전체 숫자가 정상적으로 저장되어 있습니다.
    - 하지만 Excel 등의 프로그램은 숫자만으로 구성된 긴 문자열을 자동으로 '숫자' 형식으로 인식하고, 화면에 표시할 때 공간을 절약하기 위해 지수(과학적 표기법)로 변환합니다. 이 상태로 저장하면 데이터가 영구적으로 변경될 수 있습니다.
- **해결 방법**:
    - 데이터가 텍스트임을 명시적으로 알려주어 프로그램의 자동 형식 변환을 방지해야 합니다.  
    - `useBookStore`에서 CSV를 생성할 때, ISBN 값을 `="<ISBN_VALUE>"` 형식의 문자열로 감쌌습니다.
    - 이 형식은 Excel 등에서 해당 셀의 내용을 수식(결과는 텍스트)으로 인식하게 하여, 원본 문자열을 그대로 표시하도록 강제합니다.

- **교훈 및 예방 조치**:
    - 숫자 형식의 식별자(ID, ISBN, 전화번호 등)를 데이터 파일로 내보낼 때는, 의도치 않은 자동 서식 변경을 막기 위한 처리가 필요합니다. 데이터를 텍스트로 명시적으로 지정하는 것이 가장 안정적인 방법입니다.

### **1. TypeScript 타입 호환성 에러**

- **최초 발생일**: 2025-08-01 18:30
- **에러 현상**:
    - "Conversion of type 'BookData' to type 'Json' may be a mistake" 및 "not assignable to never", "excessively deep type instantiation" 등의 TypeScript 컴파일 에러가 발생.
- **원인 분석**:
    - `StockInfo` interface가 Supabase의 `Json` 타입과 호환되지 않아 타입 캐스팅이 실패했습니다.
    - 복잡한 타입 추론 체인으로 인해 TypeScript 컴파일러가 타입을 올바르게 해석하지 못했습니다.
- **해결 방법**:
    - `StockInfo`를 interface에서 type alias로 변경하여 `Json` 타입과의 호환성을 확보했습니다.
    - 타입 정의를 단순화하여 TypeScript 컴파일러의 타입 추론 부담을 줄였습니다.
- **교훈 및 예방 조치**:
    - 외부 라이브러리와의 타입 호환성을 고려하여 interface보다는 type alias 사용을 권장합니다.
    - 복잡한 타입 체인은 가능한 한 단순화하여 컴파일러 부담을 줄이는 것이 중요합니다.

---
*문서 최종 수정일: 2025-08-01 19:20*