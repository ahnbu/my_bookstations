<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경기도 전자도서관 크롤링 디버그</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        pre { white-space: pre-wrap; word-break: break-all; }
        button { padding: 10px 20px; margin: 5px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1976D2; }
    </style>
</head>
<body>
    <h1>경기도 전자도서관 크롤링 디버그</h1>
    
    <div>
        <input type="text" id="titleInput" value="머니 트렌드 2025 - 새로운 부의 기회를 선점할 55가지 성공 시나리오" style="width: 500px;">
        <button onclick="testTitle()">제목 처리 테스트</button>
        <button onclick="openDirectURL()">직접 검색 URL 열기</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        function processGyeonggiEbookTitle(title) {
            const specialChars = /[,\-:;()[\]{}]/;
            
            let processedTitle = title;
            const match = title.search(specialChars);
            if (match !== -1) {
                processedTitle = title.substring(0, match).trim();
            }
            
            const words = processedTitle.split(' ').filter(word => word.trim() !== '');
            return words.slice(0, 3).join(' ');
        }
        
        function addResult(content, type = 'result') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = content;
            resultsDiv.appendChild(div);
        }
        
        function testTitle() {
            const title = document.getElementById('titleInput').value;
            const processed = processGyeonggiEbookTitle(title);
            
            addResult(`
                <h3>제목 처리 결과</h3>
                <p><strong>원본:</strong> ${title}</p>
                <p><strong>처리됨:</strong> ${processed}</p>
            `, 'success');
        }
        
        function createGyeonggiEbookSearchURL(title) {
            const processedTitle = processGyeonggiEbookTitle(title);
            // URL 수동 구성 (올바른 인코딩을 위해)
            const baseUrl = "https://ebook.library.kr/search";
            const encodedTitle = encodeURIComponent(processedTitle).replace(/'/g, '%27');
            const detailQuery = `TITLE:${encodedTitle}:true`;
            
            return `${baseUrl}?detailQuery=${detailQuery}&OnlyStartWith=false&searchType=all&listType=list`;
        }

        function openDirectURL() {
            const title = document.getElementById('titleInput').value;
            const processed = processGyeonggiEbookTitle(title);
            
            // 기존 방식 (문제있는 URL)
            const oldUrl = new URL("https://ebook.library.kr/search");
            oldUrl.searchParams.set("detailQuery", `TITLE:${processed}:true`);
            oldUrl.searchParams.set("OnlyStartWith", "false");
            oldUrl.searchParams.set("searchType", "all");
            oldUrl.searchParams.set("listType", "list");
            
            // 새로운 방식 (수정된 URL)
            const newUrl = createGyeonggiEbookSearchURL(title);
            
            addResult(`
                <h3>URL 비교 결과</h3>
                <p><strong>처리된 제목:</strong> ${processed}</p>
                <div style="background:#ffebee; padding:10px; margin:5px 0; border-radius:4px;">
                    <p><strong>❌ 기존 URL (문제):</strong></p>
                    <p style="font-size:12px; word-break:break-all;"><a href="${oldUrl.toString()}" target="_blank">${oldUrl.toString()}</a></p>
                    <p><em>공백이 +로 인코딩됨</em></p>
                </div>
                <div style="background:#e8f5e8; padding:10px; margin:5px 0; border-radius:4px;">
                    <p><strong>✅ 수정된 URL (정상):</strong></p>
                    <p style="font-size:12px; word-break:break-all;"><a href="${newUrl}" target="_blank">${newUrl}</a></p>
                    <p><em>공백이 %20으로 인코딩됨</em></p>
                </div>
                <p>수정된 URL을 클릭하여 검색 결과를 확인하세요.</p>
            `, 'success');
            
            // 새 창에서 수정된 URL 열기
            window.open(newUrl, '_blank');
        }
        
        // CloudFlare Workers API 테스트 (CORS 문제로 실제로는 작동하지 않을 수 있음)
        async function testCloudFlareAPI() {
            const title = document.getElementById('titleInput').value;
            const processed = processGyeonggiEbookTitle(title);
            
            const payload = {
                isbn: "9791170402008", // 가상 ISBN
                title: processed
            };
            
            addResult(`
                <h3>CloudFlare API 테스트</h3>
                <p><strong>요청 데이터:</strong></p>
                <pre>${JSON.stringify(payload, null, 2)}</pre>
                <p><em>CORS 문제로 인해 브라우저에서는 직접 테스트가 어려울 수 있습니다.</em></p>
            `);
        }
        
        // 페이지 로드 시 자동으로 제목 처리 테스트 실행
        window.onload = function() {
            testTitle();
        };
    </script>
</body>
</html>